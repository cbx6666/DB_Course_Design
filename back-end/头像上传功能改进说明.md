# 头像上传功能改进说明

## 修改概述

本次修改改进了用户头像上传功能，现在 `UpdateUserAvatarAsync` 方法已经被正确集成到账户更新流程中。

## 主要修改

### 1. DTO 修改 (`UserPlaceOrderDto.cs`)

- 添加了 `IFormFile? AvatarFile` 属性支持文件上传
- 保留了 `string? Image` 属性用于向后兼容
- 添加了 `Microsoft.AspNetCore.Http` 引用

### 2. 服务层修改 (`UserPlaceOrderService.cs`)

- 修改了 `UpdateAccountAsync` 方法，现在支持两种头像处理方式：
  - **文件上传**：当 `AvatarFile` 不为空时，调用 `UpdateUserAvatarAsync` 方法处理文件上传
  - **向后兼容**：当 `Image` 字段不为空时，直接使用Base64字符串（保持原有功能）

### 3. 控制器修改 (`UserPlaceOrderController.cs`)

- 将 `UpdateAccountInfo` 方法的参数绑定从 `[FromBody]` 改为 `[FromForm]`
- 移除了 `[Required]` 属性，因为现在支持文件上传

## 功能特性

### 文件上传方式
- 支持通过 `multipart/form-data` 上传头像文件
- 文件会被保存到 `wwwroot/avatars/` 目录
- 文件名格式：`{userId}_{Guid}.{extension}`
- 返回文件访问URL：`/avatars/{fileName}`

### 向后兼容
- 仍然支持原有的Base64字符串方式
- 前端可以继续使用现有实现，无需立即修改

## API 使用方式

### 方式1：文件上传（推荐）
```http
PUT /api/account/update
Content-Type: multipart/form-data

Id: 1
Name: 用户名
AvatarFile: [文件]
```

### 方式2：Base64字符串（向后兼容）
```http
PUT /api/account/update
Content-Type: application/json

{
  "id": 1,
  "name": "用户名",
  "image": "data:image/jpeg;base64,..."
}
```

## 前端适配建议

### 推荐的前端实现
```javascript
// 使用FormData上传文件
const formData = new FormData();
formData.append('Id', userId);
formData.append('Name', userName);
formData.append('AvatarFile', avatarFile);

const response = await fetch('/api/account/update', {
  method: 'PUT',
  body: formData,
  headers: {
    'Authorization': `Bearer ${token}`
  }
});
```

### 向后兼容实现
```javascript
// 继续使用Base64方式（现有代码无需修改）
const data = {
  id: userId,
  name: userName,
  image: base64String
};

const response = await fetch('/api/account/update', {
  method: 'PUT',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  },
  body: JSON.stringify(data)
});
```

## 优势

1. **性能提升**：文件上传方式避免了Base64字符串的传输和存储开销
2. **存储优化**：数据库中只存储文件URL，不存储文件内容
3. **向后兼容**：现有前端代码无需立即修改
4. **灵活性**：支持两种方式，可以根据需要选择

## 测试

使用 `BackEnd.http` 文件中的测试用例进行API测试：
- 文件上传测试
- Base64字符串测试

## 注意事项

1. 确保 `wwwroot/avatars/` 目录存在且有写入权限
2. 文件上传大小限制需要在 `Program.cs` 中配置
3. 建议添加文件类型验证和大小限制
4. 考虑添加文件清理机制，删除旧的头像文件
